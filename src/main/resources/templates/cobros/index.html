<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Cobros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #2c3e50; padding-top: 20px; color: white; z-index: 1000;}
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: #b0b8c1; display: block; }
        .sidebar a:hover, .sidebar a.active { background-color: #34495e; color: white; border-left: 4px solid #1abc9c; }
        .main-content { margin-left: 250px; padding: 20px; }
        .header-purple { background-color: #6f42c1; color: white; padding: 10px 15px; border-radius: 5px 5px 0 0; font-weight: bold; }
        .table-header-purple { background-color: #6f42c1; color: white; }
    </style>
</head>
<body>

<div th:replace="~{fragments/sidebar :: sidebar-component}"></div>

<div class="main-content">
    <h4 class="text-secondary mb-3">GESTIÓN DE COBROS MENSUALES</h4>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-primary" onclick="limpiarModal()"><i class="fas fa-hand-holding-usd"></i> Registrar Pago</button>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="header-purple"><i class="fas fa-filter me-1"></i> Filtro</div>
        <div class="card-body bg-light">
             <form action="/cobros" method="get" class="row g-3">
                <div class="col-md-3"><label class="form-label small">Cliente</label><input type="text" name="cliente" class="form-control form-control-sm"></div>
                <div class="col-md-3"><label class="form-label small">Mes</label>
                    <select name="mes" class="form-select form-select-sm">
                        <option>Todos</option><option value="Marzo 2025">Marzo 2025</option><option value="Abril 2025">Abril 2025</option><option value="Mayo 2025">Mayo 2025</option>
                    </select>
                </div>
                <div class="col-md-3"><label class="form-label small">Estado</label>
                    <select name="estado" class="form-select form-select-sm">
                        <option>Todos</option><option value="Pagado">Pagado</option><option value="Pendiente">Pendiente</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end"><button type="submit" class="btn btn-primary btn-sm w-100">Filtrar</button></div>
             </form>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-header-purple">
                    <tr><th>CLIENTE</th><th>MES</th><th>MONTO</th><th>FECHA PAGO</th><th>VENCIMIENTO</th><th>ESTADO</th><th>ACCIÓN</th></tr>
                </thead>
                <tbody>
                    <tr th:each="c : ${listaCobros}">
                        <td th:text="${c.nombreCliente}" class="fw-bold"></td>
                        <td th:text="${c.mesConcepto}"></td>
                        <td th:text="'S/ ' + ${c.monto}"></td>
                        <td th:text="${c.fechaPago}"></td>
                        <td th:text="${c.fechaVencimiento}" class="text-danger fw-bold"></td>
                        <td>
                            <span th:if="${c.estado == 'Pagado'}" class="badge bg-success">Pagado</span>
                            <span th:if="${c.estado == 'Pendiente'}" class="badge bg-danger">Pendiente</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                    th:onclick="editarCobro(
                                        [[${c.id}]], 
                                        [[${c.nombreCliente}]], 
                                        [[${c.monto}]], 
                                        [[${c.mesConcepto}]], 
                                        [[${c.medioPago}]], 
                                        [[${c.fechaPago}]], 
                                        [[${c.estado}]],
                                        [[${c.diasValidez}]]
                                    )">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a th:href="@{/cobros/eliminar/{id}(id=${c.id})}" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar?')"><i class="fas fa-trash"></i></a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCobro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitulo">Registrar Pago</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/cobros/guardar}" th:object="${cobro}" method="post">
                <div class="modal-body">
                    <input type="hidden" th:field="*{id}" id="txtId">
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="fw-bold text-primary">Mes a Cobrar</label>
                            <select th:field="*{mesConcepto}" id="txtConcepto" class="form-select" onchange="filtrarClientesPorMes()">
                                <option value="Marzo 2025">Marzo 2025</option>
                                <option value="Abril 2025">Abril 2025</option>
                                <option value="Mayo 2025">Mayo 2025</option>
                            </select>
                        </div>
                        <div class="col-6"><label>Monto (S/)</label><input type="number" step="0.1" th:field="*{monto}" id="txtMonto" class="form-control fw-bold" required></div>
                    </div>

                    <div class="mb-3">
                        <label>Cliente</label>
                        <select id="selectCliente" class="form-select" onchange="cargarMontoAutomatico()">
                            <option value="" data-monto="0" data-nombre="">-- Buscar Cliente --</option>
                            <option th:each="inst : ${listaInstalaciones}" 
                                    th:value="${inst.id}"
                                    th:data-nombre="${inst.nombreCliente}"
                                    th:data-monto="${inst.plan != null ? inst.plan.costo : 0}"
                                    th:text="${inst.nombreCliente} + ' - S/' + (${inst.plan != null ? inst.plan.costo : '0'})">
                            </option>
                        </select>
                        <input type="hidden" th:field="*{nombreCliente}" id="txtNombreClienteReal">
                        <small id="msgSinClientes" class="text-danger d-none">Todos los clientes ya pagaron este mes.</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label>Días Servicio</label>
                            <input type="number" th:field="*{diasValidez}" id="txtDias" class="form-control" value="30">
                        </div>
                        <div class="col-6"><label>Fecha Pago</label><input type="date" th:field="*{fechaPago}" id="txtFecha" class="form-control"></div>
                    </div>

                    <div class="row mb-3">
                         <div class="col-6"><label>Medio</label><select th:field="*{medioPago}" id="txtMedio" class="form-select"><option value="Efectivo">Efectivo</option><option value="Yape/Plin">Yape/Plin</option></select></div>
                         <div class="col-6"><label>Estado</label><select th:field="*{estado}" id="txtEstado" class="form-select"><option value="Pagado">Pagado</option><option value="Pendiente">Pendiente</option></select></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Guardar</button></div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    
    // --- LÓGICA PARA OCULTAR CLIENTES QUE YA PAGARON ---
    
    // 1. Obtenemos todos los pagos existentes desde Java
    var pagosExistentes = /*[[${listaCobros}]]*/ [];
    
    // Inicializar Modal
    var myModal;
    document.addEventListener('DOMContentLoaded', function () { 
        myModal = new bootstrap.Modal(document.getElementById('modalCobro'));
    });

    function limpiarModal() {
        document.getElementById('txtId').value = '';
        document.getElementById('txtMonto').value = '';
        document.getElementById('selectCliente').value = ''; 
        document.getElementById('modalTitulo').innerText = 'Registrar Pago';
        
        // Al abrir, filtramos según el mes que esté seleccionado por defecto
        filtrarClientesPorMes();
        myModal.show();
    }

    // FUNCIÓN INTELIGENTE: Oculta clientes duplicados
    function filtrarClientesPorMes() {
        var mesSeleccionado = document.getElementById("txtConcepto").value;
        var selectCliente = document.getElementById("selectCliente");
        var opciones = selectCliente.options;
        var contadorVisibles = 0;

        // Recorremos cada opción del select de clientes
        for (var i = 1; i < opciones.length; i++) { // Empezamos en 1 para saltar el "-- Buscar --"
            var nombreCliente = opciones[i].getAttribute("data-nombre");
            var yaPago = false;

            // Revisamos si este cliente tiene un pago en el mes seleccionado
            for (var j = 0; j < pagosExistentes.length; j++) {
                if (pagosExistentes[j].nombreCliente === nombreCliente && pagosExistentes[j].mesConcepto === mesSeleccionado) {
                    yaPago = true;
                    break;
                }
            }

            // Si ya pagó, ocultamos la opción. Si no, la mostramos.
            if (yaPago) {
                opciones[i].style.display = "none";
            } else {
                opciones[i].style.display = "block";
                contadorVisibles++;
            }
        }
        
        // Resetear selección
        selectCliente.value = "";
        
        // Mensaje visual si todos ya pagaron
        var msg = document.getElementById("msgSinClientes");
        if(contadorVisibles === 0) {
            msg.classList.remove("d-none");
        } else {
            msg.classList.add("d-none");
        }
    }

    function cargarMontoAutomatico() {
        var select = document.getElementById("selectCliente");
        var option = select.options[select.selectedIndex];
        document.getElementById("txtMonto").value = option.getAttribute("data-monto");
        document.getElementById("txtNombreClienteReal").value = option.getAttribute("data-nombre");
    }

    function editarCobro(id, cliente, monto, concepto, medio, fecha, estado, dias) {
        document.getElementById('txtId').value = id;
        document.getElementById('txtNombreClienteReal').value = cliente; 
        document.getElementById('txtMonto').value = monto;
        document.getElementById('txtConcepto').value = concepto;
        document.getElementById('txtMedio').value = medio;
        document.getElementById('txtFecha').value = fecha;
        document.getElementById('txtEstado').value = estado;
        document.getElementById('txtDias').value = dias;
        
        // En editar, permitimos ver todo
        var opciones = document.getElementById("selectCliente").options;
        for (var i = 0; i < opciones.length; i++) opciones[i].style.display = "block";

        document.getElementById('modalTitulo').innerText = 'Editar Pago';
        myModal.show();
    }
</script>
</body>
</html>